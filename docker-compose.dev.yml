services:
  # ==========================================
  # DATABASE SERVICES
  # ==========================================

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    restart: unless-stopped
    env_file: .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    ports:
      - "3307:3306" # External 3307 to avoid conflict
    volumes:
      - mysql-data:/var/lib/mysql
      - ./backend/src/main/resources/features.sql:/docker-entrypoint-initdb.d/features.sql
    networks:
      - app-network
    profiles: ["db", "mysql"]

  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    env_file: .env
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-pet_shelter}
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - app-network
    profiles: ["db", "mongo"]

  neo4j:
    image: neo4j:5
    container_name: neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: ${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-password}
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    volumes:
      - neo4j-data:/data
    networks:
      - app-network
    profiles: ["db", "neo4j"]

  # ==========================================
  # APPLICATION SERVICES
  # ==========================================

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    restart: unless-stopped
    env_file: .env
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE_ACTIVE:-mysql}
      JDBC_DATABASE_URL: ${JDBC_DATABASE_URL:-jdbc:mysql://mysql:3306/pet_shelter}
      JDBC_USERNAME: ${JDBC_USERNAME:-root}
      JDBC_PASSWORD: ${JDBC_PASSWORD:-password}
      MONGODB_URI: ${MONGODB_URI:-mongodb://root:password@mongodb:27017/pet_shelter?authSource=admin}
      MONGODB_DATABASE: ${MONGODB_DATABASE:-pet_shelter}
      NEO4J_URI: ${NEO4J_URI:-bolt://neo4j:7687}
      NEO4J_USERNAME: ${NEO4J_USERNAME:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-password}
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:-dev-access-secret}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev-refresh-secret}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:5173,http://localhost}
      MIGRATION_ENABLED: ${MIGRATION_ENABLED:-false}
      MIGRATION_NEO4J_ENABLED: ${MIGRATION_NEO4J_ENABLED:-false}
    ports:
      - "8080:8080"
    # depends_on:
    #   - mysql
    #   - mongodb
    #   - neo4j
    networks:
      - app-network
    profiles: ["app"]

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_PROD_API_BASE_URL: ${VITE_PROD_API_BASE_URL:-http://localhost/api}
    container_name: frontend
    restart: unless-stopped
    networks:
      - app-network
    profiles: ["app"]

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - frontend
      - backend
    networks:
      - app-network
    profiles: ["app"]

networks:
  app-network:
    driver: bridge

volumes:
  mysql-data:
  mongo-data:
  neo4j-data:
